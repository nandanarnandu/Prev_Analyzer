<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prevalalyzer</title>

  <!-- Bootstrap & FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <style>
  body {
    background: linear-gradient(135deg, #2b2b2b, #404040, #1a1a1a);
    color: #ffe600;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    min-height: 100vh;
    padding-top: 30px;
    padding-bottom: 100px; /* üëà ensures enough scroll space at bottom */
    overflow-y: auto;       /* üëà allows vertical scrolling */
  }

  .main-card {
    background: rgba(42, 42, 42, 0.95);
    border: 3px solid #ffe600;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 20px 40px rgba(255, 230, 0, 0.2);
  }

  .gradient-text {
    background: linear-gradient(45deg, #ffe600, #ffed4e);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 20px rgba(255, 230, 0, 0.3);
  }

  .text-muted {
    color: #b3b3b3 !important;
  }

  .btn-yellow {
    background: linear-gradient(45deg, #ffe600, #ffed4e);
    border: 2px solid #ffe600;
    color: #2b2b2b;
    font-weight: bold;
    transition: all 0.3s ease;
  }

  .btn-yellow:hover {
    background: #2b2b2b;
    color: #ffe600;
    border-color: #ffe600;
    box-shadow: 0 5px 15px rgba(255, 230, 0, 0.3);
  }

  .card-header {
    background: linear-gradient(45deg, #ffe600, #ffed4e);
    color: #2b2b2b;
    font-weight: bold;
    border-bottom: 2px solid #ffe600;
  }

  .form-control {
    background: rgba(42, 42, 42, 0.9);
    border: 2px solid #ffe600;
    color: #ffe600;
  }

  .form-control::file-selector-button {
    background-color: #ffe600;
    border: 1px solid #ffe600;
    color: #2b2b2b;
    font-weight: bold;
    border-radius: 5px;
    margin-right: 10px;
  }

  .form-text {
    color: #ffe600;
    font-size: 0.9rem;
  }

  .card {
    border: 2px solid #ffe600 !important;
    background-color: rgba(42, 42, 42, 0.9);
    color: #ffe600;
  }

  .alert-success {
    background: rgba(255, 230, 0, 0.15);
    border: 1px solid #ffe600;
    color: #ffe600;
    font-weight: bold;
  }

  .alert-warning {
    background: rgba(255, 165, 0, 0.1);
    border: 1px solid orange;
    color: orange;
    font-weight: bold;
  }

  /* üëá Optional improvement for table scroll */
  .table-responsive {
    margin-top: 20px;
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #ffe600;
  }

  /* üëá Optional: Smooth scroll behavior for buttons */
  html {
    scroll-behavior: smooth;
  }

  window.onload = function () {
    const previewSection = document.querySelector(".table-responsive");
    if (previewSection) {
      previewSection.scrollIntoView({ behavior: "smooth" });
    }
  };
</style>
<!-- üìú CodeMirror CSS & JS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/python/python.min.js"></script>
</head>

<!--script-->

<body>
  <!-- HEADER SECTION -->
  <div class="container text-center mb-4">
    <h1 class="display-4 fw-bold gradient-text mb-2">üõ°Ô∏è PREVANALYZER</h1>
    <p class="lead text-muted">E-commerce Data Analysis with Auto-Protection & AI Assistant</p>
  </div>

  <!-- FILE UPLOAD SECTION -->
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card border-0 shadow-sm p-4">
        <!-- Upload Section Header -->
        <div class="card-header mb-3 rounded">
          <h5 class="mb-0"><i class="fas fa-upload me-2"></i> Upload Your Data</h5>
        </div>
        <!-- Upload Section Body -->
        <div class="card-body pt-2">
          <!-- File input field -->
          <form method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data">
            <div class="mb-4">
              <label for="file-input" class="form-label fw-semibold">Choose File</label>
              <input type="file" id="file-input" name="file" class="form-control" accept=".xlsx,.xls,.csv" required>
              <div class="form-text mt-2">Supported formats: Excel (.xlsx, .xls) and CSV files</div>
            </div>
            <!-- Upload Button -->
            <div class="d-grid">
              <button type="submit" class="btn btn-yellow">
                <i class="fas fa-cloud-upload-alt me-2"></i> Upload & Analyze
              </button>
            </div>
          </form>
          {% if filename %}
            <div class="mt-3 text-success text-center fw-semibold">
              <i class="fas fa-file-upload me-1"></i> Uploaded File: {{ filename }}
            </div>
          {% endif %}
          <!-- Status message -->
          <div id="upload-status" class="mt-4"></div>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- üö® FLASHED MESSAGES -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} mt-3 text-center" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- ‚öôÔ∏è Data Protection Form -->
{% if columns %}
  <form action="{{ url_for('apply_protection') }}" method="POST">
    <input type="hidden" name="filename" value="{{ filename }}">
    <div class="card mt-4 p-3">
      <h5 class="mb-3">üõ°Ô∏è Select Protection Method for Each Column</h5>
      {% for col in columns %}
        <div class="mb-3">
          <label class="form-label fw-semibold">{{ col }}</label>
          <select name="protection_{{ col }}" class="form-select">
            <option value="none" selected>None</option>
            <option value="encryption">Encryption</option>
            <option value="masking">Masking</option>
            <option value="hashing">Hashing</option>
            <option value="tokenization">Tokenization</option>
          </select>
        </div>
      {% endfor %}
      <button type="submit" class="btn btn-yellow mt-3">Apply Protection</button>
    </div>
  </form>
  <!-- üñäÔ∏è Custom Protection Technique Editor -->
  <div class="card mt-4 p-3">
    <h5 class="mb-3"><i class="fas fa-code"></i> Edit Custom Data Protection Logic</h5>
    <p class="text-muted small">Write your own Python function to protect the data. The function will receive a <code>pandas.DataFrame</code> and must return a modified <code>DataFrame</code>.</p>
    
    <textarea id="codeEditor" name="custom_code">
  def custom_protection(df):
      # Example: Mask all values in "Email" column
      if "Email" in df.columns:
          df["Email"] = df["Email"].apply(lambda x: str(x)[:3] + "***")
      return df
    </textarea>

    <button type="button" class="btn btn-yellow mt-3" onclick="saveCustomCode()">Save & Apply Custom Code</button>
  </div>
{% endif %}

<div id="processed-data">
    {% if tables %}
        <h3>Processed Data</h3>
        {% for table in tables %}
            {{ table | safe }}
        {% endfor %}
    {% endif %}
</div>

<!-- üîê Show Protected Data -->
{% if protected_preview and protected_preview|length > 0 %}
  <div class="mt-4">
    <h5 class="text-warning text-center">üîê Protected Data</h5>

    <!-- üì• Download Button with Spinner -->
    <div class="text-center mb-3">
      <button id="downloadBtn" class="btn btn-yellow">
        <i class="fas fa-download me-2"></i> Download Protected File
      </button>
      <div id="loadingSpinner" class="mt-2 text-warning" style="display: none;">
        <i class="fas fa-spinner fa-spin"></i> Preparing download...
      </div>
    </div>

    <!-- üîê Data Table -->
    <div class="table-responsive">
      <table class="table table-bordered table-dark table-striped table-hover">
        <thead>
          <tr>
            {% for col in protected_preview[0].keys() %}
              <th>{{ col }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in protected_preview %}
            <tr>
              {% for val in row.values() %}
                <td>{{ val }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}

<!-- üöÄ JS: Download Button Spinner Logic -->
<script>
  document.getElementById("downloadBtn")?.addEventListener("click", function () {
    const spinner = document.getElementById("loadingSpinner");
    spinner.style.display = "block";
    setTimeout(() => {
      window.location.href = "{{ url_for('download_protected') }}";
    }, 1000);
  });
</script>

<!-- ü§ñ Chatbot FAB Icon (hidden initially) -->
<div id="chatbotToggle" style="display:none; position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
  <button class="btn btn-yellow rounded-circle shadow" style="width: 60px; height: 60px;" onclick="toggleChatbot()">
    <i class="fas fa-robot fa-lg"></i>
  </button>
</div>

<!-- üí¨ Chatbot Box (Hidden by default) -->
<div id="chatbotBox" class="card shadow-lg" style="display:none; position: fixed; bottom: 90px; right: 20px; width: 300px; max-height: 400px; z-index: 9999; background-color: #2b2b2b; border: 2px solid #ffe600; color: #ffe600;">
  <div class="card-header d-flex justify-content-between align-items-center bg-warning text-dark">
    <strong><i class="fas fa-comments me-1"></i> Ask Your Data</strong>
    <button type="button" class="btn-close btn-sm" onclick="toggleChatbot()" style="filter: invert(1);"></button>
  </div>
  <div class="card-body p-2" style="overflow-y: auto;">
    <div id="chatResponse" class="small text-warning" style="min-height: 80px;"></div>
    <input type="text" id="chatInput" class="form-control form-control-sm mt-2"
  placeholder="Ask a question..." 
  onkeydown="if(event.key==='Enter') sendMessage()"
  style="background-color: #ffe600; color: #2b2b2b; font-weight: bold; border: 2px solid #2b2b2b;" />
    <button class="btn btn-yellow btn-sm w-100 mt-2" onclick="sendMessage()"><i class="fas fa-paper-plane me-1"></i>Send</button>
  </div>
</div>

<script>
  function toggleChatbot() {
    const box = document.getElementById("chatbotBox");
    box.style.display = (box.style.display === "none") ? "block" : "none";
  }

  function sendMessage() {
    const input = document.getElementById("chatInput");
    const message = input.value.trim();
    const responseBox = document.getElementById("chatResponse");
    if (!message) return;

    responseBox.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Thinking...";
    fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message })
    })
    .then(res => res.json())
    .then(data => {
      responseBox.innerHTML = `<i class='fas fa-robot me-1'></i> ${data.answer}`;
      input.value = "";
    })
    .catch(err => {
      responseBox.innerHTML = "‚ùå Failed to contact chatbot.";
      console.error(err);
    });
  }

  // Show chatbot icon only if file is uploaded
  {% if filename %}
    document.getElementById("chatbotToggle").style.display = "block";
  {% endif %}
</script>
  </div>
  <script>
  let editor;
  window.onload = function () {
    const textarea = document.getElementById("codeEditor");
    if (textarea) {
      editor = CodeMirror.fromTextArea(textarea, {
        lineNumbers: true,
        mode: "python",
        theme: "default",
        tabSize: 4
      });
      editor.setSize("100%", "200px");
    }
  };


  document.getElementById("applyCustomCodeBtn").addEventListener("click", function () {
    const code = editor.getValue(); // assuming you have a code editor
    const filename = document.getElementById("filenameInput").value; // store filename in a hidden input

    fetch("/apply_custom_code", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: code, filename: filename })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Insert table
            document.getElementById("tableContainer").innerHTML = data.table;

            // Show the same download button
            const downloadBtn = document.getElementById("downloadBtn");
            downloadBtn.style.display = "inline-block";
            downloadBtn.onclick = function () {
                window.location.href = `/uploads/${data.download_file}`;
            };

            alert(data.message);
        } else {
            alert(data.message);
        }
    })
    .catch(err => {
        console.error("Error applying custom code:", err);
        alert("‚ùå Something went wrong.");
    });
});

function saveCustomCode() {
  const customCode = editor.getValue();
  fetch("/apply_custom_code", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ code: customCode, filename: "{{ filename }}" })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    if (data.success && data.protected_preview) {
      const tempWrapper = document.createElement('div');
      let tableHtml = `<table class="table table-bordered table-dark table-striped table-hover"><thead><tr>`;
      
      const columns = Object.keys(data.protected_preview[0]);
      columns.forEach(col => {
        tableHtml += `<th>${col}</th>`;
      });
      tableHtml += `</tr></thead><tbody>`;
      
      data.protected_preview.forEach(row => {
        tableHtml += `<tr>`;
        columns.forEach(col => {
          tableHtml += `<td>${row[col]}</td>`;
        });
        tableHtml += `</tr>`;
      });
      tableHtml += `</tbody></table>`;
      
      tempWrapper.innerHTML = tableHtml;
      document.getElementById("processed-data").innerHTML = tempWrapper.innerHTML;

      const downloadBtnContainer = document.querySelector('.download-container');
      if (downloadBtnContainer) {
          downloadBtnContainer.style.display = "block";
      }
      document.getElementById("downloadBtn").dataset.filename = data.download_file;
    }
  })
  .catch(err => {
    console.error(err);
    alert("‚ùå Failed to apply custom code.");
  });
}

document.getElementById("downloadBtn")?.addEventListener("click", function () {
    const spinner = document.getElementById("loadingSpinner");
    spinner.style.display = "block";
    const filename = this.dataset.filename;
    setTimeout(() => {
        window.location.href = `/download_protected?filename=${filename}`;
    }, 1000);
});

</script>
</body>
</html>